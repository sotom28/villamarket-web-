<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Realizar Pedido - Villa Markets</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome para iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- SweetAlert2 para alertas mejoradas -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Favicon -->
    <link rel="icon" href="img/logo.png" type="image/png">
    <style>
        .text-green {
            color: #2d8f3c;
        }
        .bg-green {
            background-color: #2d8f3c;
            color: white;
        }
        .btn-green {
            background-color: #2d8f3c;
            color: white;
        }
        .btn-green:hover {
            background-color: #1a5e24;
            color: white;
        }
        .cart-container {
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.07);
            padding: 20px;
            margin-bottom: 20px;
        }
        .cart-item {
            border-bottom: 1px solid #eee;
            padding: 15px 0;
        }
        .cart-item:last-child {
            border-bottom: none;
        }
        .cart-item img {
            max-width: 64px;
            max-height: 64px;
            object-fit: contain;
        }
        .cart-summary {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
        }
        .cart-badge {
            position: relative;
            top: -8px;
            right: -5px;
        }
        .checkout-step {
            position: relative;
            padding-bottom: 20px;
        }
        .checkout-step::before {
            content: '';
            position: absolute;
            left: 17px;
            top: 30px;
            height: calc(100% - 30px);
            width: 2px;
            background-color: #2d8f3c;
        }
        .checkout-step:last-child::before {
            display: none;
        }
        .step-icon {
            width: 36px;
            height: 36px;
            background-color: #2d8f3c;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
        }
        .payment-method {
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .payment-method:hover {
            border-color: #2d8f3c;
        }
        .payment-method.selected {
            border-color: #2d8f3c;
            background-color: rgba(45, 143, 60, 0.05);
        }
        .delivery-option {
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .delivery-option:hover {
            border-color: #2d8f3c;
        }
        .delivery-option.selected {
            border-color: #2d8f3c;
            background-color: rgba(45, 143, 60, 0.05);
        }
        .minimarket-selector {
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body class="d-flex flex-column min-vh-100 bg-light">
    <!-- Barra de navegación -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm sticky-top">
        <div class="container">
            <a class="navbar-brand fw-bold d-flex align-items-center gap-2" href="home.html">
                <img src="img/logo.png" alt="Villa Markets" width="40" height="40" class="rounded">
                Villa Markets
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#nav" aria-controls="nav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div id="nav" class="collapse navbar-collapse">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="home.html">Inicio</a></li>
                    <li class="nav-item"><a class="nav-link" href="minimarkets.html">Minimarkets</a></li>
                    <li class="nav-item"><a class="nav-link" href="productos.html">Catálogo</a></li>
                    <li class="nav-item"><a class="nav-link" href="comidas.html">Comidas</a></li>
                    <li class="nav-item">
                        <a class="nav-link position-relative" href="carrito.html">
                            <i class="fas fa-shopping-cart"></i>
                            <span id="cart-count" class="badge rounded-pill bg-danger cart-badge">0</span>
                        </a>
                    </li>
                    <li class="nav-item"><a class="nav-link" href="menuprincipal.html">Mi Cuenta</a></li>
                    <li class="nav-item"><a class="nav-link" href="login.html">Login</a></li>
                    <li class="nav-item"><a class="nav-link" href="registro.html">Registrarse</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Contenido Principal -->
    <div class="container py-4">
        <h1 class="text-green mb-4">Finalizar Pedido</h1>
        
        <div class="row">
            <!-- Sección izquierda - Pasos de compra -->
            <div class="col-lg-8">
                <!-- Revisión del carrito -->
                <div class="cart-container">
                    <div class="d-flex align-items-center mb-3">
                        <div class="step-icon">
                            <i class="fas fa-shopping-cart"></i>
                        </div>
                        <h4 class="mb-0">Revisa tu pedido</h4>
                    </div>
                    
                    <div id="checkout-cart-items">
                        <!-- Se carga dinámicamente -->
                    </div>
                    
                    <div class="d-flex justify-content-between mt-3 pt-3 border-top">
                        <div>
                            <p class="mb-0"><strong>Total productos:</strong> <span id="checkout-items-count">0</span></p>
                        </div>
                        <div>
                            <p class="mb-0"><strong>Subtotal:</strong> <span id="checkout-subtotal">$0</span></p>
                        </div>
                    </div>
                </div>
                
                <!-- Método de entrega -->
                <div class="cart-container checkout-step">
                    <div class="d-flex align-items-center mb-3">
                        <div class="step-icon">
                            <i class="fas fa-truck"></i>
                        </div>
                        <h4 class="mb-0">Método de entrega</h4>
                    </div>
                    
                    <div class="delivery-options mt-3">
                        <div class="delivery-option selected" onclick="seleccionarEntrega('recoger')">
                            <div class="d-flex align-items-center">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="deliveryOption" id="recoger" value="recoger" checked>
                                </div>
                                <div class="ms-3">
                                    <label class="form-check-label fw-bold" for="recoger">
                                        Recoger en tienda
                                    </label>
                                    <p class="mb-0 small text-muted">Pasa a buscar tu pedido cuando esté listo</p>
                                </div>
                                <div class="ms-auto">
                                    <span class="badge bg-success">Gratis</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="delivery-option" onclick="seleccionarEntrega('delivery')">
                            <div class="d-flex align-items-center">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="deliveryOption" id="delivery" value="delivery">
                                </div>
                                <div class="ms-3">
                                    <label class="form-check-label fw-bold" for="delivery">
                                        Delivery a domicilio
                                    </label>
                                    <p class="mb-0 small text-muted">Recibe tu pedido en casa</p>
                                </div>
                                <div class="ms-auto">
                                    <span class="badge bg-dark">$2.990</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="recoger-opciones" class="mt-3">
                        <h6>Selecciona el minimarket donde recogerás tu pedido:</h6>
                        <div class="minimarket-selector">
                            <!-- Se carga dinámicamente -->
                        </div>
                    </div>
                    
                    <div id="delivery-opciones" class="mt-3 d-none">
                        <h6>Dirección de entrega:</h6>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="calle" class="form-label">Calle</label>
                                <input type="text" class="form-control" id="calle" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="numero" class="form-label">Número</label>
                                <input type="text" class="form-control" id="numero" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="comuna" class="form-label">Comuna</label>
                                <select class="form-select" id="comuna" required>
                                    <option value="" selected disabled>Selecciona una comuna</option>
                                    <option value="Santiago">Santiago</option>
                                    <option value="Providencia">Providencia</option>
                                    <option value="Las Condes">Las Condes</option>
                                    <option value="Ñuñoa">Ñuñoa</option>
                                    <option value="La Florida">La Florida</option>
                                    <option value="La Reina">La Reina</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="depto" class="form-label">Depto/Casa (opcional)</label>
                                <input type="text" class="form-control" id="depto">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="referencias" class="form-label">Referencias adicionales (opcional)</label>
                            <textarea class="form-control" id="referencias" rows="2"></textarea>
                        </div>
                    </div>
                </div>
                
                <!-- Forma de pago -->
                <div class="cart-container checkout-step">
                    <div class="d-flex align-items-center mb-3">
                        <div class="step-icon">
                            <i class="fas fa-credit-card"></i>
                        </div>
                        <h4 class="mb-0">Forma de pago</h4>
                    </div>
                    
                    <div class="payment-methods mt-3">
                        <div class="payment-method selected" onclick="seleccionarPago('efectivo')">
                            <div class="d-flex align-items-center">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="paymentMethod" id="efectivo" value="efectivo" checked>
                                </div>
                                <div class="ms-3">
                                    <label class="form-check-label fw-bold" for="efectivo">
                                        Efectivo
                                    </label>
                                    <p class="mb-0 small text-muted">Paga al recoger o al momento de la entrega</p>
                                </div>
                                <div class="ms-auto">
                                    <i class="fas fa-money-bill-wave fa-lg text-success"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="payment-method" onclick="seleccionarPago('tarjeta')">
                            <div class="d-flex align-items-center">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="paymentMethod" id="tarjeta" value="tarjeta">
                                </div>
                                <div class="ms-3">
                                    <label class="form-check-label fw-bold" for="tarjeta">
                                        Tarjeta de crédito/débito
                                    </label>
                                    <p class="mb-0 small text-muted">Paga online de forma segura</p>
                                </div>
                                <div class="ms-auto">
                                    <i class="fab fa-cc-visa fa-lg me-2"></i>
                                    <i class="fab fa-cc-mastercard fa-lg me-2"></i>
                                    <i class="fab fa-cc-amex fa-lg"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="payment-method" onclick="seleccionarPago('transferencia')">
                            <div class="d-flex align-items-center">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="paymentMethod" id="transferencia" value="transferencia">
                                </div>
                                <div class="ms-3">
                                    <label class="form-check-label fw-bold" for="transferencia">
                                        Transferencia bancaria
                                    </label>
                                    <p class="mb-0 small text-muted">Te enviaremos los datos por email</p>
                                </div>
                                <div class="ms-auto">
                                    <i class="fas fa-university fa-lg text-primary"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="tarjeta-opciones" class="mt-3 d-none">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="cardNumber" class="form-label">Número de tarjeta</label>
                                <input type="text" class="form-control" id="cardNumber" placeholder="1234 5678 9012 3456">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="cardName" class="form-label">Nombre en la tarjeta</label>
                                <input type="text" class="form-control" id="cardName">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="cardExpiry" class="form-label">Fecha de expiración</label>
                                <input type="text" class="form-control" id="cardExpiry" placeholder="MM/AA">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="cardCVV" class="form-label">CVV</label>
                                <input type="text" class="form-control" id="cardCVV" placeholder="123">
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Información de contacto -->
                <div class="cart-container">
                    <div class="d-flex align-items-center mb-3">
                        <div class="step-icon">
                            <i class="fas fa-user"></i>
                        </div>
                        <h4 class="mb-0">Información de contacto</h4>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="nombre" class="form-label">Nombre</label>
                            <input type="text" class="form-control" id="nombre" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="apellido" class="form-label">Apellido</label>
                            <input type="text" class="form-control" id="apellido" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="email" class="form-label">Email</label>
                            <input type="email" class="form-control" id="email" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="telefono" class="form-label">Teléfono</label>
                            <input type="tel" class="form-control" id="telefono" required>
                        </div>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" value="" id="subscribir">
                        <label class="form-check-label" for="subscribir">
                            Quiero recibir ofertas y novedades de Villa Markets
                        </label>
                    </div>
                </div>
            </div>
            
            <!-- Sección derecha - Resumen de la compra -->
            <div class="col-lg-4">
                <div class="cart-summary sticky-lg-top" style="top: 20px;">
                    <h4 class="mb-3">Resumen del pedido</h4>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Productos (<span id="resumen-cantidad">0</span>):</span>
                        <span id="resumen-subtotal">$0</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>IVA (19%):</span>
                        <span id="resumen-iva">$0</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Envío:</span>
                        <span id="resumen-envio">$0</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Descuentos:</span>
                        <span id="resumen-descuentos" class="text-danger">-$0</span>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between mb-3">
                        <span class="fw-bold">Total:</span>
                        <span class="fw-bold text-green" id="resumen-total">$0</span>
                    </div>
                    
                    <!-- Código de descuento -->
                    <div class="mb-3">
                        <div class="input-group">
                            <input type="text" class="form-control" id="codigo-descuento" placeholder="Código de descuento">
                            <button class="btn btn-outline-secondary" type="button" onclick="aplicarDescuento()">Aplicar</button>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="notas" class="form-label">Notas adicionales (opcional)</label>
                        <textarea class="form-control" id="notas" rows="2" placeholder="Instrucciones especiales para tu pedido..."></textarea>
                    </div>
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" value="" id="terminos" required>
                        <label class="form-check-label" for="terminos">
                            Acepto los <a href="#" class="text-decoration-none">términos y condiciones</a>
                        </label>
                    </div>
                    
                    <button class="btn btn-green w-100" onclick="confirmarPedido()">
                        <i class="fas fa-check-circle me-1"></i> Confirmar Pedido
                    </button>
                    
                    <div class="text-center mt-3">
                        <small class="text-muted">
                            <i class="fas fa-lock me-1"></i> Pago seguro garantizado
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-dark text-white py-4 mt-auto">
        <div class="container">
            <div class="row">
                <div class="col-md-4">
                    <h5>Villa Markets</h5>
                    <p>Tu plataforma para mini markets locales en todo Chile.</p>
                </div>
                <div class="col-md-4">
                    <h5>Enlaces rápidos</h5>
                    <ul class="list-unstyled">
                        <li><a href="minimarkets.html" class="text-white">Minimarkets</a></li>
                        <li><a href="productos.html" class="text-white">Catálogo</a></li>
                        <li><a href="soporte.html" class="text-white">Soporte</a></li>
                    </ul>
                </div>
                <div class="col-md-4">
                    <h5>Contáctanos</h5>
                    <p>contacto@villamarkets.cl</p>
                    <p>+56 9 1234 5678</p>
                </div>
            </div>
            <hr>
            <p class="text-center small mb-0">© 2025 Villa Markets. Todos los derechos reservados.</p>
        </div>
    </footer>

    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Variables globales
        let carrito = JSON.parse(localStorage.getItem('carritoVillaMarkets')) || [];
        let costoEnvio = 0; // Inicialmente es gratis (recoger en tienda)
        let descuento = 0;
        let minimarketSeleccionado = null;
        let metodoPago = 'efectivo';
        let tipoEntrega = 'recoger';
        
        // Minimarkets disponibles
        const minimarkets = [
            {
                id: 'M001',
                nombre: 'Villa Central',
                direccion: 'Av. Central 123',
                comuna: 'Santiago',
                horario: 'Lun-Vie: 8:00-21:00, Sáb-Dom: 9:00-20:00'
            },
            {
                id: 'M002',
                nombre: 'Villa Norte',
                direccion: 'Av. Norte 456',
                comuna: 'La Reina',
                horario: 'Lun-Vie: 8:00-21:00, Sáb-Dom: 9:00-20:00'
            },
            {
                id: 'M003',
                nombre: 'Villa Sur',
                direccion: 'Av. Sur 789',
                comuna: 'La Florida',
                horario: 'Lun-Vie: 8:00-21:00, Sáb-Dom: 9:00-20:00'
            },
            {
                id: 'M004',
                nombre: 'Villa Este',
                direccion: 'Av. Este 321',
                comuna: 'Ñuñoa',
                horario: 'Lun-Vie: 8:00-21:00, Sáb-Dom: 9:00-20:00'
            }
        ];
        
        /**
         * Inicializa la página de pedidos
         */
        document.addEventListener('DOMContentLoaded', function() {
            // Verificar si hay productos en el carrito
            if (carrito.length === 0) {
                window.location.href = 'carrito.html';
                return;
            }
            
            // Cargar datos del usuario si está logueado
            cargarDatosUsuario();
            
            // Renderizar productos del carrito
            renderizarCarritoCheckout();
            
            // Cargar minimarkets disponibles
            cargarMinimarkets();
            
            // Actualizar resumen
            actualizarResumen();
        });
        
        /**
         * Carga los datos del usuario si está logueado
         */
        function cargarDatosUsuario() {
            const usuario = JSON.parse(localStorage.getItem('usuarioActual'));
            if (usuario) {
                document.getElementById('nombre').value = usuario.nombre || '';
                document.getElementById('apellido').value = usuario.apellidos || '';
                document.getElementById('email').value = usuario.email || '';
                document.getElementById('telefono').value = usuario.telefono || '';
                
                // Si tiene dirección guardada, cargarla en el formulario de delivery
                if (usuario.direccion) {
                    const direccionPartes = usuario.direccion.split(', ');
                    if (direccionPartes.length >= 2) {
                        const calleNumero = direccionPartes[0].split(' ');
                        const numero = calleNumero.pop();
                        const calle = calleNumero.join(' ');
                        
                        document.getElementById('calle').value = calle;
                        document.getElementById('numero').value = numero;
                        
                        if (direccionPartes.length >= 3) {
                            document.getElementById('comuna').value = direccionPartes[1];
                            document.getElementById('depto').value = direccionPartes[2];
                        }
                    }
                }
            }
        }
        
        /**
         * Renderiza los productos del carrito en la página de checkout
         */
        function renderizarCarritoCheckout() {
            const contenedor = document.getElementById('checkout-cart-items');
            if (!contenedor) return;
            
            contenedor.innerHTML = '';
            
            carrito.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'cart-item';
                div.innerHTML = `
                    <div class="row align-items-center">
                        <div class="col-2">
                            <img src="${item.imagen}" alt="${item.nombre}" class="img-fluid">
                        </div>
                        <div class="col-6">
                            <h6 class="mb-0">${item.nombre}</h6>
                            <small class="text-muted">${item.tipo ? `Tipo: ${item.tipo}` : ''}</small>
                            <small class="d-block text-muted">${item.minimarket || 'Todos los minimarkets'}</small>
                        </div>
                        <div class="col-2 text-center">
                            <span class="badge bg-secondary">${item.cantidad}x</span>
                        </div>
                        <div class="col-2 text-end">
                            <span class="fw-bold">$${(item.precio * item.cantidad).toLocaleString('es-CL')}</span>
                        </div>
                    </div>
                `;
                
                contenedor.appendChild(div);
            });
            
            // Actualizar contador y subtotal
            const cantidad = carrito.reduce((total, item) => total + item.cantidad, 0);
            const subtotal = carrito.reduce((total, item) => total + (item.precio * item.cantidad), 0);
            
            document.getElementById('checkout-items-count').textContent = cantidad;
            document.getElementById('checkout-subtotal').textContent = `$${subtotal.toLocaleString('es-CL')}`;
            document.getElementById('cart-count').textContent = cantidad;
        }
        
        /**
         * Carga la lista de minimarkets disponibles
         */
        function cargarMinimarkets() {
            const contenedor = document.querySelector('.minimarket-selector');
            if (!contenedor) return;
            
            contenedor.innerHTML = '';
            
            minimarkets.forEach(market => {
                const div = document.createElement('div');
                div.className = 'form-check mb-2';
                div.innerHTML = `
                    <input class="form-check-input" type="radio" name="minimarket" id="${market.id}" value="${market.id}" ${market.id === 'M001' ? 'checked' : ''}>
                    <label class="form-check-label" for="${market.id}">
                        <strong>${market.nombre}</strong>
                        <div class="small text-muted">${market.direccion}, ${market.comuna}</div>
                        <div class="small text-muted">${market.horario}</div>
                    </label>
                `;
                
                contenedor.appendChild(div);
                
                // Agregar evento al radio button
                const input = div.querySelector('input');
                input.addEventListener('change', function() {
                    minimarketSeleccionado = market.id;
                    actualizarResumen();
                });
            });
            
            // Establecer el primer minimarket como seleccionado por defecto
            minimarketSeleccionado = 'M001';
        }
        
        /**
         * Maneja la selección del método de entrega
         * @param {string} metodo - 'recoger' o 'delivery'
         */
        function seleccionarEntrega(metodo) {
            tipoEntrega = metodo;
            
            // Actualizar UI
            document.querySelectorAll('.delivery-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            const radioRecoger = document.getElementById('recoger');
            const radioDelivery = document.getElementById('delivery');
            
            const opcionesRecoger = document.getElementById('recoger-opciones');
            const opcionesDelivery = document.getElementById('delivery-opciones');
            
            if (metodo === 'recoger') {
                document.querySelector('.delivery-option:first-child').classList.add('selected');
                radioRecoger.checked = true;
                opcionesRecoger.classList.remove('d-none');
                opcionesDelivery.classList.add('d-none');
                costoEnvio = 0;
            } else {
                document.querySelector('.delivery-option:last-child').classList.add('selected');
                radioDelivery.checked = true;
                opcionesRecoger.classList.add('d-none');
                opcionesDelivery.classList.remove('d-none');
                costoEnvio = 2990;
            }
            
            // Actualizar resumen
            actualizarResumen();
        }
        
        /**
         * Maneja la selección del método de pago
         * @param {string} metodo - 'efectivo', 'tarjeta' o 'transferencia'
         */
        function seleccionarPago(metodo) {
            metodoPago = metodo;
            
            // Actualizar UI
            document.querySelectorAll('.payment-method').forEach(option => {
                option.classList.remove('selected');
            });
            
            const radioEfectivo = document.getElementById('efectivo');
            const radioTarjeta = document.getElementById('tarjeta');
            const radioTransferencia = document.getElementById('transferencia');
            
            const opcionesTarjeta = document.getElementById('tarjeta-opciones');
            
            if (metodo === 'efectivo') {
                document.querySelector('.payment-method:nth-child(1)').classList.add('selected');
                radioEfectivo.checked = true;
                opcionesTarjeta.classList.add('d-none');
            } else if (metodo === 'tarjeta') {
                document.querySelector('.payment-method:nth-child(2)').classList.add('selected');
                radioTarjeta.checked = true;
                opcionesTarjeta.classList.remove('d-none');
            } else {
                document.querySelector('.payment-method:nth-child(3)').classList.add('selected');
                radioTransferencia.checked = true;
                opcionesTarjeta.classList.add('d-none');
            }
        }
        
        /**
         * Aplica un código de descuento al pedido
         */
        function aplicarDescuento() {
            const codigo = document.getElementById('codigo-descuento').value.trim().toUpperCase();
            
            if (codigo === 'VILLA10') {
                const subtotal = carrito.reduce((total, item) => total + item.precio * item.cantidad, 0);
                descuento = subtotal * 0.1; // 10% de descuento
                
                Swal.fire({
                    icon: 'success',
                    title: '¡Descuento aplicado!',
                    text: 'Descuento del 10% aplicado a tu pedido',
                    confirmButtonColor: '#2d8f3c'
                });
                
                actualizarResumen();
            } else if (codigo === 'ENVIOGRATIS') {
                const descuentoEnvio = costoEnvio;
                costoEnvio = 0;
                
                Swal.fire({
                    icon: 'success',
                    title: '¡Envío gratis!',
                    text: 'Descuento de envío gratis aplicado a tu pedido',
                    confirmButtonColor: '#2d8f3c'
                });
                
                actualizarResumen();
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Código inválido',
                    text: 'El código de descuento no es válido',
                    confirmButtonColor: '#2d8f3c'
                });
            }
        }
        
        /**
         * Actualiza el resumen del pedido con los totales calculados
         */
        function actualizarResumen() {
            const subtotal = carrito.reduce((total, item) => total + item.precio * item.cantidad, 0);
            const iva = subtotal * 0.19;
            const total = subtotal + iva + costoEnvio - descuento;
            const cantidad = carrito.reduce((total, item) => total + item.cantidad, 0);
            
            // Actualizar resumen
            document.getElementById('resumen-cantidad').textContent = cantidad;
            document.getElementById('resumen-subtotal').textContent = `$${subtotal.toLocaleString('es-CL')}`;
            document.getElementById('resumen-iva').textContent = `$${iva.toLocaleString('es-CL')}`;
            document.getElementById('resumen-envio').textContent = costoEnvio > 0 ? `$${costoEnvio.toLocaleString('es-CL')}` : 'Gratis';
            document.getElementById('resumen-descuentos').textContent = descuento > 0 ? `-$${descuento.toLocaleString('es-CL')}` : '-$0';
            document.getElementById('resumen-total').textContent = `$${total.toLocaleString('es-CL')}`;
        }
        
        /**
         * Valida el formulario de pedido
         * @returns {boolean} true si el formulario es válido, false en caso contrario
         */
        function validarFormulario() {
            // Validar información de contacto
            const nombre = document.getElementById('nombre').value.trim();
            const apellido = document.getElementById('apellido').value.trim();
            const email = document.getElementById('email').value.trim();
            const telefono = document.getElementById('telefono').value.trim();
            const terminos = document.getElementById('terminos').checked;
            
            if (!nombre || !apellido || !email || !telefono) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Datos incompletos',
                    text: 'Por favor, completa todos los campos de información de contacto',
                    confirmButtonColor: '#2d8f3c'
                });
                return false;
            }
            
            // Validar email con expresión regular simple
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Email inválido',
                    text: 'Por favor, ingresa un email válido',
                    confirmButtonColor: '#2d8f3c'
                });
                return false;
            }
            
            // Validar términos y condiciones
            if (!terminos) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Términos y condiciones',
                    text: 'Debes aceptar los términos y condiciones para continuar',
                    confirmButtonColor: '#2d8f3c'
                });
                return false;
            }
            
            // Validar dirección si es delivery
            if (tipoEntrega === 'delivery') {
                const calle = document.getElementById('calle').value.trim();
                const numero = document.getElementById('numero').value.trim();
                const comuna = document.getElementById('comuna').value.trim();
                
                if (!calle || !numero || !comuna) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Dirección incompleta',
                        text: 'Por favor, completa los datos de dirección para el delivery',
                        confirmButtonColor: '#2d8f3c'
                    });
                    return false;
                }
            }
            
            // Validar tarjeta si el método de pago es tarjeta
            if (metodoPago === 'tarjeta') {
                const cardNumber = document.getElementById('cardNumber').value.trim();
                const cardName = document.getElementById('cardName').value.trim();
                const cardExpiry = document.getElementById('cardExpiry').value.trim();
                const cardCVV = document.getElementById('cardCVV').value.trim();
                
                if (!cardNumber || !cardName || !cardExpiry || !cardCVV) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Datos de tarjeta incompletos',
                        text: 'Por favor, completa todos los campos de tu tarjeta',
                        confirmButtonColor: '#2d8f3c'
                    });
                    return false;
                }
            }
            
            return true;
        }
        
        /**
         * Confirma el pedido y lo procesa
         */
        function confirmarPedido() {
            // Validar formulario
            if (!validarFormulario()) return;
            
            // Crear objeto con datos del pedido
            const subtotal = carrito.reduce((total, item) => total + item.precio * item.cantidad, 0);
            const iva = subtotal * 0.19;
            const total = subtotal + iva + costoEnvio - descuento;
            
            const pedido = {
                id: `P-${Math.floor(Math.random() * 90000) + 10000}`, // ID aleatorio
                fecha: new Date().toLocaleDateString('es-CL'),
                hora: new Date().toLocaleTimeString('es-CL'),
                cliente: {
                    nombre: document.getElementById('nombre').value.trim(),
                    apellido: document.getElementById('apellido').value.trim(),
                    email: document.getElementById('email').value.trim(),
                    telefono: document.getElementById('telefono').value.trim()
                },
                tipoEntrega,
                metodoPago,
                minimarket: tipoEntrega === 'recoger' ? minimarketSeleccionado : null,
                direccionEntrega: tipoEntrega === 'delivery' ? {
                    calle: document.getElementById('calle').value.trim(),
                    numero: document.getElementById('numero').value.trim(),
                    depto: document.getElementById('depto').value.trim(),
                    comuna: document.getElementById('comuna').value,
                    referencias: document.getElementById('referencias').value.trim()
                } : null,
                items: carrito,
                totales: {
                    subtotal,
                    iva,
                    costoEnvio,
                    descuento,
                    total
                },
                notas: document.getElementById('notas').value.trim(),
                estado: 'Pendiente',
                fechaCreacion: new Date().toISOString()
            };
            
            // Guardar pedido en localStorage
            const pedidos = JSON.parse(localStorage.getItem('pedidosVillaMarkets')) || [];
            pedidos.push(pedido);
            localStorage.setItem('pedidosVillaMarkets', JSON.stringify(pedidos));
            
            // Limpiar carrito
            localStorage.removeItem('carrito');
            localStorage.removeItem('carritoVillaMarkets');
            
            // Mostrar mensaje de éxito
            Swal.fire({
                icon: 'success',
                title: '¡Pedido realizado con éxito!',
                html: `
                    <p>Tu pedido #${pedido.id} ha sido recibido.</p>
                    <p>Recibirás un email de confirmación en breve.</p>
                `,
                confirmButtonColor: '#2d8f3c'
            }).then(() => {
                // Redirigir a página de confirmación o cuenta
                window.location.href = 'menuprincipal.html#pedidos';
            });
        }
    </script>
</body>
</html>
